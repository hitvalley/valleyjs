var url = require('url');
var fs = require('fs');

var express = require('express');
var valleyjs = require('./valley');

var app = express();

var scriptRegex = /<script[^>]*>.*?<\/script>/g;
var conRegex = /(<(\w+).*?id="id-container"[^>]*>).*?<\2>/
var html = '';

fs.readFile('./index.html', 'utf8', function(err, data){
  var data = data.replace(/[\r\n]+/g, '');
  Valley.mainPage = html = data.replace(scriptRegex, '');
});

function runPage(name) {
  var path = Valley.conPath + '/' + name;
  var con = require(Valley.conPath + name);
  return con.render();
}
setTimeout(function(){
  runPage('demo');
}, 500);

app.get('*', function(req, res){
  var obj = url.parse(req.url);
  var con = require(__dirname + '/controllers/' + obj.pathname + '.js');
  con.render().then(function(html){
    // console.log(data);
    res.send(html);
  });
});

var server = app.listen(3001, function(){
  //var host = server.address().address || '127.0.0.1';
  var host = '127.0.0.1';
  var port = server.address().port;

  console.log('Listening at http://%s:%s', host, port);
});
